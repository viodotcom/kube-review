#!/bin/bash
# exit if any command fails
set -e

verbose=${KR_VERBOSE:-true}
if [ "$verbose" != "false" ]; then
  set -x
  export
fi

# App variables
pull_request_number=$KR_PULL_REQUEST_NUMBER
branch_name=$KR_BRANCH_NAME
repo_name=$KR_REPO_NAME
repo_owner=$KR_REPO_OWNER
job_url=$KR_JOB_URL

# Kube Review variables
prefix=${KR_PREFIX:-re}
kube_config_file=${KR_KUBE_CONFIG_FILE:-$HOME/.kube/config}
name="$prefix-${KR_ID_OVERRIDE:-$KR_ID}"
short_name=$(echo "$name" | cut -c1-15 | awk '{print tolower($0)}')
hash=$(echo "$name" | rhash -p "%c" -)
namespace=$short_name-$hash
kube_context=$KR_KUBE_CONTEXT
overlay_path=$KR_OVERLAY_PATH
base_overlay_path=${KR_BASE_OVERLAY_PATH:-"src/build/resources/base"}

build_at=$(date +%s)

config_context() {
  # kubectl locks the config for each execution. To workaround
  # and allow multiple concurrent kubectl executions we copy the config
  scoped_kubeconfig_file=$kube_config_file-$namespace
  cp "$kube_config_file" "$scoped_kubeconfig_file"
  export KUBECONFIG=${scoped_kubeconfig_file}

  if [ "$kube_context" != "" ]; then
    kubectl config use-context "$kube_context"
  fi
}

build_resources () {
  # Prepare directory structure and copy files
  work_dir=$(mktemp -d)

  # If we don't have a overlay to apply, we just run from base overlay
  cp -R "$base_overlay_path" "$work_dir"
  if [ "$overlay_path" != "" ]; then
    cp -R "$overlay_path" "$work_dir/overlay"
  fi

  overlay_target="base"
  if [ "$overlay_path" != "" ]; then
    overlay_target="overlay"
  fi

  cd "$work_dir/$overlay_target"
  kustomize edit add annotation --force \
  app.kubernetes.io/pull_request_number:"$pull_request_number" \
  app.kubernetes.io/branch_name:"$branch_name" \
  app.kubernetes.io/repository_name:"$repo_name" \
  app.kubernetes.io/repository_owner:"$repo_owner" \
  app.kubernetes.io/build_at:"$build_at" \
  app.kubernetes.io/job_url:'"'$job_url'"'

  cd; tar -v -cf overlay.tar "$work_dir"
  kubectl create secret generic -n kube-review-build "$namespace" \
    --save-config \
    --dry-run=client \
    --from-file=resources="$work_dir/overlay.tar" \
    --from-literal=overlay_target="$overlay_target" \
    -o yaml | \
    kubectl apply -f -
}

config_context
build_resources
